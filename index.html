<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce QR Scanner</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        h1 {
            color: #0070d2; /* Salesforce Blue */
            margin-bottom: 20px;
        }

        #qr-reader {
            width: 100%;
            max-width: 400px; /* Or adjust as needed */
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 20px auto;
            overflow: hidden; /* Important for camera view */
        }
        
        #qr-reader__dashboard_section_csr span button {
            background-color: #0070d2 !important;
            color: white !important;
            border: none !important;
            padding: 8px 15px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
        }

        #qr-reader__dashboard_section_csr span button:hover {
            background-color: #005fb3 !important;
        }


        .controls button {
            background-color: #0070d2;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s ease;
        }

        .controls button:hover {
            background-color: #005fb3;
        }

        .controls button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #scan-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
        }

        .status-success {
            background-color: #e6ffed;
            color: #28a745;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #ffebee;
            color: #dc3545;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background-color: #e7f3fe;
            color: #007bff;
            border: 1px solid #b8daff;
        }

        #scanned-urls-container { /* Keeping name generic, but it now stores any text */
            margin-top: 20px;
            text-align: left;
        }

        #scanned-urls-container h2 {
            font-size: 18px;
            color: #555;
            margin-bottom: 10px;
        }

        #scanned-urls-list {
            list-style-type: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
        }

        #scanned-urls-list li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            word-break: break-all;
            font-size: 14px;
        }
        #scanned-urls-list li:last-child {
            border-bottom: none;
        }
        .instructions {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 20px;
            background-color: #e7f3fe;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #0070d2;
        }
    </style>
    <!-- Include the html5-qrcode library -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Salesforce QR Scanner</h1>

        <div class="instructions">
            <p><strong>Instructions:</strong></p>
            <ol>
                <li>Click "Start Scanning" to activate the camera.</li>
                <li>Allow camera permissions if prompted.</li>
                <li>Point your camera at a QR code.</li>
                <li>Scanned text will appear in the list below.</li>
                <li>Click "Stop Scanning" to pause.</li>
                <li>Click "Send to Salesforce" when done.</li>
            </ol>
        </div>

        <div id="qr-reader"></div>
        <div id="scan-status" class="status-info">Awaiting scan...</div>

        <div class="controls">
            <button id="startButton">Start Scanning</button>
            <button id="stopButton" disabled>Stop Scanning</button>
            <button id="sendButton" disabled>Send to Salesforce</button>
        </div>

        <div id="scanned-urls-container">
            <h2>Scanned Text:</h2> <!-- Changed H2 slightly for clarity -->
            <ul id="scanned-urls-list">
                <!-- Scanned text will be appended here -->
            </ul>
        </div>
    </div>

    <script>
        const scannedUrls = []; // Renaming this variable might be good, e.g., scannedTexts, but for now keeping it for minimal changes
        let html5QrCode = null;

        const qrReaderElement = document.getElementById('qr-reader');
        const scanStatusElement = document.getElementById('scan-status');
        const scannedUrlsListElement = document.getElementById('scanned-urls-list');
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const sendButton = document.getElementById('sendButton');

        function updateScannedList() {
            scannedUrlsListElement.innerHTML = ''; // Clear existing list
            scannedUrls.forEach(text => { // Changed 'url' to 'text' for clarity in this scope
                const listItem = document.createElement('li');
                listItem.textContent = text;
                scannedUrlsListElement.appendChild(listItem);
            });
            sendButton.disabled = scannedUrls.length === 0;
        }

        // --- MODIFIED onScanSuccess ---
        function onScanSuccess(decodedText, decodedResult) {
            console.log("Raw decodedText from QR:", `"${decodedText}"`); // Log the raw text
            console.log("Decoded result object:", decodedResult);

            // Trim whitespace from the decoded text for consistency
            const trimmedDecodedText = decodedText.trim();
            console.log("Trimmed decodedText (to be added):", `"${trimmedDecodedText}"`);

            // Check if this text has already been scanned
            if (!scannedUrls.includes(trimmedDecodedText)) {
                scannedUrls.push(trimmedDecodedText); // Add the trimmed text to the list
                updateScannedList();
                scanStatusElement.textContent = `Scanned: ${trimmedDecodedText.substring(0, 40)}...`; // Show a preview
                scanStatusElement.className = 'status-success';
                console.log(`Scan result added to list: "${trimmedDecodedText}"`);
                
                // Optional: Vibrate on success (mobile only)
                if (navigator.vibrate) {
                    navigator.vibrate(100); // Vibrate for 100ms
                }
            } else {
                scanStatusElement.textContent = 'Text already scanned.';
                scanStatusElement.className = 'status-info';
                console.log(`Duplicate scan ignored: "${trimmedDecodedText}"`);
            }
        }
        // --- END MODIFIED onScanSuccess ---


        function onScanFailure(error) {
            // Handle scan failure, usually means no QR code detected in the frame.
            // console.warn(`QR error = ${error}`);
        }

        function startScanning() {
            startButton.disabled = true;
            stopButton.disabled = false;
            scanStatusElement.textContent = 'Initializing scanner... Requesting camera...';
            scanStatusElement.className = 'status-info';

            const config = { fps: 10, qrbox: { width: 250, height: 250 }, facingMode: "environment" };

            html5QrCode = new Html5Qrcode("qr-reader");
            html5QrCode.start(
                { facingMode: "environment" }, 
                config,
                onScanSuccess,
                onScanFailure
            ).then(() => {
                 scanStatusElement.textContent = 'Scanner started. Point camera at QR code.';
                 scanStatusElement.className = 'status-info';
            }).catch(err => {
                console.error("Failed to start scanner", err);
                scanStatusElement.textContent = `Error starting scanner: ${err.message}. Ensure camera access is allowed.`;
                scanStatusElement.className = 'status-error';
                stopScanning(); 
            });
        }

        function stopScanning() {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop()
                    .then(ignore => {
                        scanStatusElement.textContent = 'Scanner stopped.';
                        scanStatusElement.className = 'status-info';
                        console.log("QR Code scanning stopped.");
                    })
                    .catch(err => {
                        console.error("Failed to stop scanner", err);
                        scanStatusElement.textContent = 'Error stopping scanner.';
                        scanStatusElement.className = 'status-error';
                    })
                    .finally(() => {
                        html5QrCode = null; 
                        qrReaderElement.innerHTML = ""; 
                    });
            }
            startButton.disabled = false;
            stopButton.disabled = true;
        }

        async function sendToSalesforce() {
            if (scannedUrls.length === 0) {
                alert("No scanned text to send.");
                return;
            }

            const payload = {
                // Consider renaming 'scannedUrls' in the payload if it's not always URLs
                // For example: scannedTexts: scannedUrls 
                scannedItems: scannedUrls 
            };
            const jsonData = JSON.stringify(payload, null, 2);

            console.log("Payload to send to Salesforce:", jsonData);
            scanStatusElement.textContent = 'Preparing data for Salesforce...';
            scanStatusElement.className = 'status-info';

            // --- SIMULATION for this example (actual Salesforce integration part remains the same) ---
            scanStatusElement.textContent = 'Simulating send... Check console for JSON.';
            scanStatusElement.className = 'status-info';
            setTimeout(() => {
                 alert("Simulated Send Complete!\n\nPayload:\n" + jsonData + "\n\nCheck console for details. Implement actual Salesforce call in sendToSalesforce function.");
                 scanStatusElement.textContent = 'Simulated send complete. Data logged to console.';
                 scanStatusElement.className = 'status-success';
            }, 1500);
            // --- END SIMULATION ---
        }

        startButton.addEventListener('click', startScanning);
        stopButton.addEventListener('click', stopScanning);
        sendButton.addEventListener('click', sendToSalesforce);

        scanStatusElement.textContent = 'Click "Start Scanning" to begin.';
        
        Html5Qrcode.getCameras().then(devices => {
            if (devices && devices.length) {
                console.log("Cameras available:", devices);
            } else {
                scanStatusElement.textContent = 'No cameras found. Ensure camera is connected and permissions granted.';
                scanStatusElement.className = 'status-error';
                startButton.disabled = true;
            }
        }).catch(err => {
            scanStatusElement.textContent = 'Could not access cameras. Check permissions.';
            scanStatusElement.className = 'status-error';
            startButton.disabled = true;
            console.error("Error getting cameras", err);
        });

    </script>
</body>
</html>
