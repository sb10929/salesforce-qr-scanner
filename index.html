<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce QR Scanner</title>
    <style>
        /* ... (Keep existing styles from previous correct version) ... */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
        }

        h1 {
            color: #0070d2; /* Salesforce Blue */
            margin-bottom: 20px;
        }

        .session-inputs {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }

        .session-inputs h2 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.1em;
            color: #333;
        }

        .form-group {
            margin-bottom: 10px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .form-group input[type="text"],
        .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 0.9em;
        }
        .form-group input[readonly] {
            background-color: #e9ecef;
        }


        #qr-reader {
            width: 100%;
            max-width: 400px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 20px auto;
            overflow: hidden;
        }
        
        #qr-reader__dashboard_section_csr span button {
            background-color: #0070d2 !important;
            color: white !important;
            border: none !important;
            padding: 8px 15px !important;
            border-radius: 4px !important;
            cursor: pointer !important;
        }

        #qr-reader__dashboard_section_csr span button:hover {
            background-color: #005fb3 !important;
        }

        .controls button {
            background-color: #0070d2;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s ease;
        }

        .controls button:hover {
            background-color: #005fb3;
        }

        .controls button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        #scan-status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            min-height: 40px; /* Ensure space for messages */
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center; /* For multi-line messages */
        }

        .status-success {
            background-color: #e6ffed;
            color: #28a745;
            border: 1px solid #c3e6cb;
        }

        .status-error {
            background-color: #ffebee;
            color: #dc3545;
            border: 1px solid #f5c6cb;
        }

        .status-info {
            background-color: #e7f3fe;
            color: #007bff;
            border: 1px solid #b8daff;
        }

        #scanned-items-container {
            margin-top: 20px;
            text-align: left;
        }

        #scanned-items-container h2 {
            font-size: 18px;
            color: #555;
            margin-bottom: 10px;
        }

        #scanned-items-list {
            list-style-type: none;
            padding: 0;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 5px;
            padding: 10px;
        }

        #scanned-items-list li {
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
            word-break: break-all;
            font-size: 14px;
        }
        #scanned-items-list li:last-child {
            border-bottom: none;
        }
        .item-geo {
            font-size: 0.8em;
            color: #777;
            margin-left: 10px;
        }
        .instructions {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 20px;
            background-color: #e7f3fe;
            padding: 10px;
            border-radius: 5px;
            border-left: 4px solid #0070d2;
        }
         .instructions button { /* Style for the button inside instructions */
            padding: 3px 8px;
            font-size: 0.9em;
            margin-left: 5px;
            cursor: pointer;
            background-color: #0070d2;
            color: white;
            border: none;
            border-radius: 3px;
        }
        .instructions button:hover{
            background-color: #005fb3;
        }
        .instructions button:disabled{
            background-color: #ccc;
            cursor: not-allowed;
        }
    </style>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Salesforce QR Scanner</h1>

        <div class="session-inputs">
            <h2>Session Information</h2>
            <div class="form-group">
                <label for="location">Location:</label>
                <select id="location">
                    <option value="Hideaway Bay">Hideaway Bay</option>
                    <option value="PreOwned Center">PreOwned Center</option>
                    <option value="Surf HQ">Surf HQ</option>
                    <option value="Bennington">Bennington</option>
                </select>
            </div>
            <div class="form-group">
                <label for="scannedBy">Scanned By:</label>
                <input type="text" id="scannedBy" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label for="dateScanned">Date Scanned:</label>
                <input type="text" id="dateScanned" readonly>
            </div>
        </div>

        <div class="instructions">
            <p><strong>Instructions:</strong></p>
            <ol>
                <li>Fill in Session Information above.</li>
                <li><button id="checkLocationButton">Check/Enable Location</button> (Recommended)</li>
                <li>Click "Start Scanning" to activate the camera.</li>
                <li>Allow camera and location permissions if prompted.</li>
                <li>Point your camera at a QR code. Geolocation will be captured.</li>
                <li>Scanned items will appear in the list below.</li>
                <li>Click "Stop Scanning" to pause.</li>
                <li>Click "Send to Salesforce" when done.</li>
            </ol>
        </div>

        <div id="qr-reader"></div>
        <div id="scan-status" class="status-info">Initializing...</div>

        <div class="controls">
            <button id="startButton">Start Scanning</button>
            <button id="stopButton" disabled>Stop Scanning</button>
            <button id="sendButton" disabled>Send to Salesforce</button>
        </div>

        <div id="scanned-items-container">
            <h2>Scanned Items:</h2>
            <ul id="scanned-items-list"></ul>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Element Variables ---
            const locationSelect = document.getElementById('location');
            const scannedByInput = document.getElementById('scannedBy');
            const dateScannedInput = document.getElementById('dateScanned');
            const qrReaderElement = document.getElementById('qr-reader');
            const scanStatusElement = document.getElementById('scan-status');
            const scannedItemsListElement = document.getElementById('scanned-items-list');
            const startButton = document.getElementById('startButton');
            const stopButton = document.getElementById('stopButton');
            const sendButton = document.getElementById('sendButton');
            const checkLocationButton = document.getElementById('checkLocationButton');

            // --- Global State ---
            const scannedItems = [];
            let html5QrCode = null;

            // --- Initialization ---
            try {
                const today = new Date();
                const yyyy = today.getFullYear();
                const mm = String(today.getMonth() + 1).padStart(2, '0');
                const dd = String(today.getDate()).padStart(2, '0');
                if (dateScannedInput) {
                    dateScannedInput.value = `${yyyy}-${mm}-${dd}`;
                } else {
                    console.error("dateScannedInput element not found!");
                }
            } catch (e) {
                console.error("Error setting date:", e);
                if (scanStatusElement) scanStatusElement.textContent = "Error initializing date.";
            }


            // --- Helper Function Definitions ---
            function updateScannedList() {
                if (!scannedItemsListElement) return;
                scannedItemsListElement.innerHTML = '';
                scannedItems.forEach(item => {
                    const listItem = document.createElement('li');
                    let geoInfo = '';
                    if (item.geoError) {
                        geoInfo = `<span class="item-geo">(Geo: ${item.geoError})</span>`;
                    } else if (item.latitude !== null && item.longitude !== null) {
                        geoInfo = `<span class="item-geo">(Lat: ${item.latitude.toFixed(5)}, Lon: ${item.longitude.toFixed(5)}, Acc: ${item.accuracy}m)</span>`;
                    }
                    listItem.innerHTML = `${item.text} ${geoInfo}`;
                    scannedItemsListElement.appendChild(listItem);
                });
                if (sendButton) sendButton.disabled = scannedItems.length === 0;
            }

            async function checkInitialGeolocationPermission() {
                if (!checkLocationButton || !scanStatusElement) {
                     console.error("Required elements for geo permission check not found (checkLocationButton or scanStatusElement).");
                     if(checkLocationButton) checkLocationButton.textContent = "Geo Setup Error";
                     return;
                }
                if (navigator.geolocation && typeof navigator.permissions !== 'undefined' && typeof navigator.permissions.query === 'function') {
                    try {
                        const permissionStatus = await navigator.permissions.query({name:'geolocation'});
                        updateCheckLocationButtonText(permissionStatus.state);

                        permissionStatus.onchange = () => {
                            console.log('Geolocation permission state changed to:', permissionStatus.state);
                            updateCheckLocationButtonText(permissionStatus.state);
                            if (permissionStatus.state === 'denied' && !document.getElementById('forceGeoRequestBtnFromStatus')) {
                                scanStatusElement.innerHTML = 'Location permission is denied. Please enable it in browser settings. <button id="forceGeoRequestBtnFromStatus" style="margin-left:5px; padding: 2px 5px;">Try Request</button>';
                                scanStatusElement.className = 'status-error';
                                const forceBtn = document.getElementById('forceGeoRequestBtnFromStatus');
                                if(forceBtn) forceBtn.onclick = () => requestGeolocationPermission(true);
                            } else if (permissionStatus.state === 'granted' && scanStatusElement.innerHTML.includes('Location permission is denied')) {
                                scanStatusElement.textContent = 'Location permission granted.';
                                scanStatusElement.className = 'status-success';
                            }
                        };
                    } catch (e) {
                        console.warn("Error querying geolocation permissions:", e);
                        checkLocationButton.textContent = "Enable Location (Click)";
                    }
                } else {
                    console.warn('Geolocation Permissions API not fully supported. Manual check needed.');
                    checkLocationButton.textContent = "Check Location Manually";
                    if (!navigator.geolocation) {
                        checkLocationButton.disabled = true;
                        checkLocationButton.textContent = "Location N/A";
                         scanStatusElement.textContent = 'Geolocation is not supported by this browser.';
                         scanStatusElement.className = 'status-error';
                    }
                }
            }
            
            function updateCheckLocationButtonText(state) {
                if (!checkLocationButton) return;
                if (state === 'granted') {
                    checkLocationButton.textContent = 'Location Enabled';
                    checkLocationButton.style.backgroundColor = '#28a745'; // Green
                    checkLocationButton.disabled = true;
                } else if (state === 'denied') {
                    checkLocationButton.textContent = 'Location Denied';
                    checkLocationButton.style.backgroundColor = '#dc3545'; // Red
                    checkLocationButton.disabled = false; 
                } else { // prompt or other
                    checkLocationButton.textContent = 'Enable Location';
                    checkLocationButton.style.backgroundColor = ''; // Default button color
                    checkLocationButton.disabled = false;
                }
            }

            function requestGeolocationPermission(isExplicitRequest = false) {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        const errorMsg = 'Geolocation is not supported by your browser.';
                        if (isExplicitRequest && scanStatusElement) {
                            scanStatusElement.textContent = errorMsg;
                            scanStatusElement.className = 'status-error';
                        }
                        reject(new Error(errorMsg));
                        return;
                    }
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            if (isExplicitRequest && scanStatusElement) {
                                scanStatusElement.textContent = 'Location access granted!';
                                scanStatusElement.className = 'status-success';
                                setTimeout(() => {
                                    if (scanStatusElement && scanStatusElement.textContent === 'Location access granted!') {
                                        scanStatusElement.textContent = 'Ready to scan.';
                                        scanStatusElement.className = 'status-info';
                                    }
                                }, 3000);
                            }
                            // Manually update button if permission was just granted via this explicit request
                            if (isExplicitRequest && checkLocationButton && typeof navigator.permissions !== 'undefined' && typeof navigator.permissions.query === 'function') {
                                navigator.permissions.query({name:'geolocation'}).then(ps => updateCheckLocationButtonText(ps.state));
                            } else if (isExplicitRequest && checkLocationButton) { // Fallback if Permissions API not there
                                updateCheckLocationButtonText('granted');
                            }

                            resolve({
                                latitude: position.coords.latitude,
                                longitude: position.coords.longitude,
                                accuracy: position.coords.accuracy,
                                timestamp: new Date(position.timestamp).toISOString()
                            });
                        },
                        (error) => {
                            let errorMessage = 'Could not get location. ';
                            switch(error.code) {
                                case error.PERMISSION_DENIED:
                                    errorMessage += "Permission denied.";
                                    if (isExplicitRequest) errorMessage += " Please enable location in browser/OS settings.";
                                    break;
                                case error.POSITION_UNAVAILABLE: errorMessage += "Information unavailable."; break;
                                case error.TIMEOUT: errorMessage += "Request timed out."; break;
                                default: errorMessage += "Unknown error."; break;
                            }
                            if (isExplicitRequest && scanStatusElement) {
                                scanStatusElement.textContent = errorMessage;
                                scanStatusElement.className = 'status-error';
                            }
                             // Manually update button if permission was denied via this explicit request
                            if (isExplicitRequest && checkLocationButton && typeof navigator.permissions !== 'undefined' && typeof navigator.permissions.query === 'function') {
                                navigator.permissions.query({name:'geolocation'}).then(ps => updateCheckLocationButtonText(ps.state));
                            } else if (isExplicitRequest && checkLocationButton) { // Fallback
                                updateCheckLocationButtonText('denied');
                            }
                            reject(new Error(errorMessage));
                        },
                        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                    );
                });
            }
            
            async function fetchCurrentLocation() {
                return requestGeolocationPermission(false);
            }

            async function onScanSuccess(decodedText, decodedResult) {
                if (!scanStatusElement) return;
                const trimmedDecodedText = decodedText.trim();

                if (scannedItems.some(item => item.text === trimmedDecodedText)) {
                    scanStatusElement.textContent = 'Text already scanned.';
                    scanStatusElement.className = 'status-info';
                    return;
                }

                scanStatusElement.textContent = `Scanned: "${trimmedDecodedText.substring(0,30)}...". Getting location...`;
                scanStatusElement.className = 'status-info';

                let geoData = { latitude: null, longitude: null, accuracy: null, geoError: null, timestamp: new Date().toISOString() };

                try {
                    const location = await fetchCurrentLocation();
                    geoData.latitude = location.latitude;
                    geoData.longitude = location.longitude;
                    geoData.accuracy = location.accuracy;
                    geoData.timestamp = location.timestamp;
                    scanStatusElement.textContent = `Scanned: "${trimmedDecodedText.substring(0,30)}...". Location captured!`;
                    scanStatusElement.className = 'status-success';
                } catch (error) {
                    geoData.geoError = error.message;
                    scanStatusElement.textContent = `Scanned: "${trimmedDecodedText.substring(0,30)}...". Geo Error: ${error.message}`;
                    scanStatusElement.className = 'status-error';
                }
                scannedItems.push({ text: trimmedDecodedText, ...geoData });
                updateScannedList();
                if (navigator.vibrate) navigator.vibrate(100);
            }

            function onScanFailure(error) { /* console.warn(`QR error = ${error}`); */ }

            function startScanning() {
                if (!scannedByInput || !startButton || !stopButton || !locationSelect || !scanStatusElement || !qrReaderElement) {
                    console.error("Missing critical elements for startScanning.");
                    if (scanStatusElement) scanStatusElement.textContent = "UI Error, cannot start.";
                    return;
                }
                if (!scannedByInput.value.trim()) {
                    alert("Please enter your name in 'Scanned By' field.");
                    scannedByInput.focus();
                    return;
                }
                startButton.disabled = true;
                stopButton.disabled = false;
                locationSelect.disabled = true;
                scannedByInput.disabled = true;
                scanStatusElement.textContent = 'Initializing scanner... Requesting camera...';
                scanStatusElement.className = 'status-info';
                const config = { fps: 10, qrbox: { width: 250, height: 250 }, facingMode: "environment" };
                try {
                    html5QrCode = new Html5Qrcode("qr-reader"); // Use ID string
                    html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                        .then(() => {
                            scanStatusElement.textContent = 'Scanner started. Point camera at QR code.';
                            scanStatusElement.className = 'status-info';
                        })
                        .catch(err => {
                            console.error("Failed to start scanner", err);
                            scanStatusElement.textContent = `Error starting scanner: ${err.message}.`;
                            scanStatusElement.className = 'status-error';
                            stopScanning();
                        });
                } catch (e) {
                     console.error("Error creating Html5Qrcode instance:", e);
                     scanStatusElement.textContent = `Scanner lib error: ${e.message}.`;
                     scanStatusElement.className = 'status-error';
                     stopScanning();
                }
            }

            function stopScanning() {
                if (html5QrCode && html5QrCode.isScanning) {
                    html5QrCode.stop().catch(err => console.error("Error stopping scanner quietly", err));
                }
                // Reset UI regardless of stop success/failure
                if(scanStatusElement && scanStatusElement.textContent.startsWith("Error starting scanner")) {
                    // Don't overwrite critical error message with "Scanner stopped"
                } else if (scanStatusElement) {
                     scanStatusElement.textContent = 'Scanner stopped.';
                     scanStatusElement.className = 'status-info';
                }
                if(qrReaderElement) qrReaderElement.innerHTML = "";
                if(startButton) startButton.disabled = false;
                if(stopButton) stopButton.disabled = true;
                if(locationSelect) locationSelect.disabled = false;
                if(scannedByInput) scannedByInput.disabled = false;
                html5QrCode = null;
            }

            async function sendToSalesforce() {
                if (!scannedItems || !scannedByInput || !locationSelect || !dateScannedInput || !scanStatusElement) return;
                // ... (rest of sendToSalesforce logic from previous correct version)
                if (scannedItems.length === 0) {
                    alert("No items to send.");
                    return;
                }
                if (!scannedByInput.value.trim()) {
                    alert("Please ensure 'Scanned By' field is filled.");
                    scannedByInput.focus();
                    return;
                }

                const payload = {
                    sessionInfo: {
                        location: locationSelect.value,
                        scannedBy: scannedByInput.value.trim(),
                        dateScanned: dateScannedInput.value
                    },
                    scannedItems: scannedItems
                };
                const jsonData = JSON.stringify(payload, null, 2);

                console.log("Payload to send to Salesforce:", jsonData);
                scanStatusElement.textContent = 'Preparing data for Salesforce...';
                scanStatusElement.className = 'status-info';

                scanStatusElement.textContent = 'Simulating send... Check console for JSON.';
                scanStatusElement.className = 'status-info';
                setTimeout(() => {
                    alert("Simulated Send Complete!\n\nPayload:\n" + jsonData + "\n\nCheck console. Implement actual Salesforce call.");
                    scanStatusElement.textContent = 'Simulated send complete. Data logged to console.';
                    scanStatusElement.className = 'status-success';
                }, 1500);
            }

            // --- Attach Event Listeners & Initial Calls ---
            if (startButton) startButton.addEventListener('click', startScanning);
            else console.error("startButton not found for event listener!");

            if (stopButton) stopButton.addEventListener('click', stopScanning);
            else console.error("stopButton not found for event listener!");
            
            if (sendButton) sendButton.addEventListener('click', sendToSalesforce);
            else console.error("sendButton not found for event listener!");

            if (checkLocationButton) {
                checkLocationButton.addEventListener('click', async () => {
                    checkLocationButton.disabled = true;
                    checkLocationButton.textContent = "Checking...";
                    try {
                        await requestGeolocationPermission(true);
                    } catch(e) {
                        console.log("Explicit geo request failed from button. Status message should reflect error.");
                    }
                    // Re-check and update button text regardless of try/catch outcome,
                    // as permission might have changed or user needs clear feedback.
                    // The requestGeolocationPermission itself tries to update button via Permissions API if available.
                    // This is a fallback.
                    if (!(navigator.permissions && typeof navigator.permissions.query === 'function')) {
                        // If permissions API not available, enable button for another try after a delay
                         setTimeout(() => { if(checkLocationButton && checkLocationButton.textContent === "Checking...") {
                            checkLocationButton.disabled = false;
                            checkLocationButton.textContent = "Retry Location";
                         } }, 2000);
                    }
                });
            } else {
                console.error("checkLocationButton not found for event listener!");
            }

            // Initial UI setup and checks
            if (scanStatusElement) {
                scanStatusElement.textContent = 'Fill session info & click "Start Scanning".';
                scanStatusElement.className = 'status-info';
            } else {
                console.error("scanStatusElement not found for initial text!");
            }
            
            checkInitialGeolocationPermission();

            try {
                Html5Qrcode.getCameras().then(devices => {
                    if (!devices || !devices.length) {
                        if (scanStatusElement) {
                            scanStatusElement.textContent = 'No cameras found. Ensure camera and permissions.';
                            scanStatusElement.className = 'status-error';
                        }
                        if (startButton) startButton.disabled = true;
                    }
                }).catch(err => {
                    if (scanStatusElement) {
                        scanStatusElement.textContent = 'Could not access cameras. Check permissions.';
                        scanStatusElement.className = 'status-error';
                    }
                    if (startButton) startButton.disabled = true;
                    console.error("Error getting cameras", err);
                });
            } catch (e) {
                console.error("Error during Html5Qrcode.getCameras():", e);
                if (scanStatusElement) scanStatusElement.textContent = "Camera check library error.";
                if (startButton) startButton.disabled = true;
            }


        }); // End of DOMContentLoaded
    </script>
</body>
</html>
