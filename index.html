<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Salesforce QR/VIN Scanner</title>
    <style>
        /* --- FIX: Prevent horizontal scrolling --- */
        html, body {
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0; 
            background-color: #f4f7f6;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 500px;
            text-align: center;
            box-sizing: border-box; 
            margin: 20px 0;
        }

        h1 {
            color: #0070d2;
            margin-bottom: 20px;
        }

        .session-inputs {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }

        .salesforce-login-area {
            background-color: #f0f8ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 112, 210, 0.15);
        }

        .sf-login-button {
            background-color: #0070d2;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            transition: background-color 0.3s ease, transform 0.2s ease;
            display: inline-block; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .sf-login-button:hover {
            background-color: #005fb3; 
            transform: translateY(-2px); 
        }

        .sf-login-button:active {
            background-color: #004a8c;
            transform: translateY(0px); 
        }

        .sf-status-message {
            margin-top: 15px;
            padding: 10px 15px;
            border-radius: 5px;
            font-weight: 500; 
            font-size: 0.95em;
        }

        .sf-status-message.status-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .sf-status-message.status-error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .sf-status-message.status-info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }

        .controls button {
            background-color: #0070d2; 
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background-color 0.3s ease;
        }

        .controls button:hover { background-color: #005fb3; }
        .controls button:disabled { background-color: #ccc; cursor: not-allowed; }

        .session-inputs h2 { margin-top: 0; margin-bottom: 15px; font-size: 1.1em; color: #333; }
        .form-group { margin-bottom: 10px; position: relative; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-group input[type="text"], .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-size: 0.9em; }
        .form-group input[readonly] { background-color: #e9ecef; }

        .scanner-viewport-container {
            position: relative;
            width: 100%;
            max-width: 400px;
            margin: 20px auto;
            border-radius: 8px;
            overflow: hidden;
        }

        #qr-reader {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #333;
            box-sizing: border-box;
        }

        #qr-reader video { width: 100% !important; height: auto !important; }
        #qr-reader__dashboard { flex-wrap: wrap !important; }
        #qr-reader__dashboard_section_csr span button { background-color: #0070d2 !important; color: white !important; border: none !important; padding: 8px 15px !important; border-radius: 4px !important; cursor: pointer !important; }
        #qr-reader__dashboard_section_csr span button:hover { background-color: #005fb3 !important; }

        #scan-success-overlay {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background-color: rgba(40, 167, 69, 0.85); color: white; padding: 15px 25px;
            border-radius: 8px; font-size: 1.2em; font-weight: bold; text-align: center;
            z-index: 100; opacity: 0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            pointer-events: none; display: flex; align-items: center;
        }
        #scan-success-overlay.visible { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
        #scan-success-overlay svg { width: 30px; height: 30px; margin-right: 10px; stroke: white; stroke-width: 5; stroke-linecap: round; stroke-linejoin: round; }
        
        .manual-entry-controls button { background-color: #17a2b8; color: white; border: none; padding: 10px 15px; border-radius: 5px; cursor: pointer; font-size: 1em; }
        .manual-entry-controls button:hover { background-color: #138496; }

        .vin-search-results { position: absolute; background-color: white; border: 1px solid #ccc; border-top: none; z-index: 1000; width: calc(100% - 2px); max-height: 150px; overflow-y: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.1); left: 0; right: 0; }
        .vin-search-results div { padding: 8px 10px; cursor: pointer; font-size: 0.9em; }
        .vin-search-results div:hover { background-color: #f0f0f0; }
        .vin-search-results div.no-results { cursor: default; color: #777; }
        
        #manualEntryFormContainer h3 { margin-top: 0; color: #333; }
        #manualEntryFormContainer .controls-button { padding: 10px 15px; font-size: 0.9em; border-radius: 4px; cursor: pointer; border:none; color: white; }
        #addManualEntryButton { background-color: #0070d2; }
        #addManualEntryButton:hover { background-color: #005fb3; }
        #cancelManualEntryButton { background-color: #6c757d; }
        #cancelManualEntryButton:hover { background-color: #5a6268; }

        #scan-status { margin-top: 15px; padding: 10px; border-radius: 5px; font-weight: bold; min-height: 40px; display: flex; align-items: center; justify-content: center; text-align: center; }
        .status-success { background-color: #e6ffed; color: #28a745; border: 1px solid #c3e6cb; }
        .status-error { background-color: #ffebee; color: #dc3545; border: 1px solid #f5c6cb; }
        .status-info { background-color: #e7f3fe; color: #007bff; border: 1px solid #b8daff; }
        
        #scanned-items-container { margin-top: 20px; text-align: left; }
        #scanned-items-container h2 { font-size: 18px; color: #555; margin-bottom: 10px; }
        #scanned-items-list { list-style-type: none; padding: 0; max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 5px; padding: 10px; }
        #scanned-items-list li { padding: 8px 0; border-bottom: 1px solid #f0f0f0; word-break: break-all; font-size: 14px; }
        #scanned-items-list li:last-child { border-bottom: none; }
        .item-geo { font-size: 0.8em; color: #777; margin-left: 10px; }
        
        .instructions { font-size: 0.9em; color: #666; margin-bottom: 20px; background-color: #e7f3fe; padding: 10px; border-radius: 5px; border-left: 4px solid #0070d2; }
        .instructions button { padding: 3px 8px; font-size: 0.9em; margin-left: 5px; cursor: pointer; background-color: #0070d2; color: white; border: none; border-radius: 3px; }
        .instructions button:hover{ background-color: #005fb3; }
        .instructions button:disabled{ background-color: #ccc; cursor: not-allowed; }

        /* --- NEW STYLES FOR VIN SCANNER --- */
        .scan-mode-toggle {
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
        }
        .scan-mode-toggle button {
            flex: 1;
            padding: 10px;
            background-color: #f0f0f0;
            border: none;
            cursor: pointer;
            font-size: 1em;
            color: #333;
            transition: background-color 0.3s, color 0.3s;
            margin: 0 !important; /* Override other button margins */
            border-radius: 0 !important; /* Override other button radius */
        }
        .scan-mode-toggle button.active {
            background-color: #0070d2;
            color: white;
            font-weight: bold;
        }
        #vin-scan-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 85%;
            height: 20%;
            border: 3px solid rgba(255, 255, 255, 0.9);
            background-color: rgba(0, 0, 0, 0.1);
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5); /* Creates the dark "cutout" effect */
            border-radius: 8px;
            display: none; /* Hidden by default */
            pointer-events: none;
        }
    </style>
    <!-- JS Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsforce/1.11.1/jsforce.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
</head>
<body>
    <div class="container">
        <h1>Salesforce QR/VIN Scanner</h1>

        <div id="salesforce-login-section" class="salesforce-login-area">
            <button id="salesforceLoginButton" class="sf-login-button">Login to Salesforce</button>
            <div id="salesforceStatus" class="sf-status-message status-info">Not logged into Salesforce.</div>
        </div>

        <div id="initial-setup-instructions">
             <div class="instructions" style="text-align: left; margin-top: 20px;">
                <p><strong>To begin, please complete the following steps:</strong></p>
                <ol>
                    <li>Login to Salesforce using the button above.</li>
                    <li>Enable location services for this app by clicking here: <button id="checkLocationButton">Enable Location</button></li>
                </ol>
             </div>
        </div>

    <div id="main-app-content" style="display: none;">

        <div class="session-inputs">
            <h2>Session Information</h2>
            <div class="form-group">
                <label for="location">Location:</label>
                <select id="location">
                    <option value="" selected disabled>-- Select a Location --</option>
                    <option value="Hideaway Bay">Hideaway Bay</option>
                    <option value="Pre-Owned">Pre-Owned</option>
                    <option value="Surf Headquarters">Surf Headquarters</option>
                    <option value="Bennington Showroom">Bennington Showroom</option>
                </select>
            </div>
            <div class="form-group">
                <label for="scannedBy">Scanned By:</label>
                <input type="text" id="scannedBy" placeholder="Enter your name">
            </div>
            <div class="form-group">
                <label for="dateScanned">Date Scanned:</label>
                <input type="text" id="dateScanned" readonly>
            </div>
        </div>

        <div class="manual-entry-controls" style="margin-bottom: 20px;">
            <button id="toggleManualEntryButton">Manual Entry</button>
        </div>

        <div id="manualEntryFormContainer" style="display: none; background-color: #f0f8ff; padding: 15px; border-radius: 5px; margin-bottom: 20px; text-align: left;">
            <h3>Manual Trailer Entry</h3>
            <div class="form-group">
                <label for="manualVin">VIN:</label>
                <input type="text" id="manualVin" placeholder="Enter trailer VIN (Required)">
                <small id="vinSearchHelp" style="display: block; font-size: 0.8em; color: #555; margin-top: 3px;">
                    Type at least 4 characters to search.
                </small>
                <div id="vinSearchResults" class="vin-search-results" style="display:none;"></div>
            </div>
            <div class="form-group">
                <label for="manualMake">Make:</label>
                <input type="text" id="manualMake" placeholder="Enter trailer make (Required)">
            </div>
            <div class="form-group">
                <label for="manualNewType">Type (Required if not found in SF):</label>
                <select id="manualNewType">
                    <option value="">-- Select Type --</option>
                    <option value="New - In Stock">New - In Stock</option>
                    <option value="New - On Order">New - On Order</option>
                    <option value="Customer Trailer">Customer Trailer</option>
                    <option value="Brokerage(Customer Owned)">Brokerage(Customer Owned)</option>
                    <option value="Used">Used</option>
                </select>
            </div>
            <div class="form-group">
                <label for="manualTrailerType">Trailer Type (Required if not found in SF):</label>
                <select id="manualTrailerType">
                    <option value="">-- Select Trailer Type --</option>
                    <option value="Pontoon">Pontoon</option>
                    <option value="Inboard">Inboard</option>
                    <option value="Runabout">Runabout</option>
                    <option value="PWC">PWC</option>
                    <option value="Center Console">Center Console</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group">
                <label for="manualModel">Model:</label>
                <input type="text" id="manualModel" placeholder="Enter trailer model (Optional)">
            </div>
            <div class="form-group">
                <label for="manualTrailerOwner">Trailer Owner:</label>
                <input type="text" id="manualTrailerOwner" placeholder="Enter trailer owner (Optional)">
            </div>
            <button id="addManualEntryButton" class="controls-button" style="margin-right: 10px;">Add to List</button>
            <button id="cancelManualEntryButton" class="controls-button" style="background-color: #6c757d;">Cancel</button>
            <div id="manualEntryStatus" style="margin-top: 10px; font-weight: bold;"></div>
        </div>

        <div class="scan-mode-toggle">
            <button id="modeQrButton" class="active">Scan QR Code</button>
            <button id="modeVinButton">Scan VIN</button>
        </div>

        <div class="instructions">
            <p><strong>Instructions:</strong> Select a mode, fill Session Info, then click "Start Scanning".</p>
        </div>

        <div class="scanner-viewport-container">
            <div id="qr-reader"></div>
            <div id="vin-scan-overlay"></div>
            <div id="scan-success-overlay">
                <svg viewBox="0 0 50 50">
                    <path fill="transparent" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
                <span>Scan Successful!</span>
            </div>
        </div>

        <div id="scan-status" class="status-info">Initializing...</div>

        <div class="controls">
            <button id="startButton">Start Scanning</button>
            <button id="stopButton" disabled>Stop Scanning</button>
            <button id="sendButton" disabled>Send to Salesforce</button>
        </div>

        <div id="scanned-items-container">
            <h2>Scanned Items:</h2>
            <ul id="scanned-items-list"></ul>
        </div>
    </div>
    </div>

    <script>
        // --- Global State & Configuration ---
        const SF_LOGIN_URL = 'https://login.salesforce.com'; 
        const SF_CLIENT_ID = '3MVG9CEn_O3jvv0xeuSn24uJCAhIryOkfnoEp2ZgmnvNi52WNzeAiPJL.30DLpudVIe0MTsA1RutfP7vq2abX'; 
        const SF_REDIRECT_URI = 'https://sb10929.github.io/salesforce-qr-scanner/'; 
        const PLATFORM_EVENT_API_NAME = 'QR_Scan_Event__e'; 
        const SF_VIN_SEARCH_OBJECT = 'Marine__Trailer__c'; 
        const SF_VIN_FIELD_API_NAME = 'Marine__VIN__c'; 
        const SF_MAKE_FIELD_API_NAME = 'Marine__Make__c'; 
        const SF_TYPE_FIELD_API_NAME = 'Marine__Type__c';
        const MIN_VIN_SEARCH_LENGTH = 4; 

        let sfConnection = null;
        const scannedItems = [];
        let html5QrCode = null;
        let vinSearchDebounceTimer = null; 
        let selectedSalesforceTrailerId = null; 
        let isSalesforceLoggedIn = false;
        let isLocationEnabled = false;

        // --- OCR (VIN Scanning) State ---
        let scanMode = 'QR'; // 'QR' or 'VIN'
        let ocrWorker = null;
        let ocrStream = null;
        let isOcrRunning = false;
        let videoElementForOcr = null;

        // --- DOM Element Variables ---
        let locationSelect, scannedByInput, dateScannedInput, scannerViewportContainer,
            qrReaderDivForLibrary, scanStatusElement, scannedItemsListElement,
            startButton, stopButton, sendButton, checkLocationButton, scanSuccessOverlay,
            toggleManualEntryButton, manualEntryFormContainer, manualMakeInput,
            manualVinInput, addManualEntryButton, cancelManualEntryButton, manualEntryStatus,
            salesforceLoginButton, salesforceStatusElement,
            manualNewTypeSelect, manualTrailerTypeSelect, manualModelInput, manualTrailerOwnerInput,
            vinSearchResultsDiv, vinSearchHelpText, modeQrButton, modeVinButton, vinScanOverlay;

        // --- OCR Initialization ---
        async function initializeOcrWorker() {
            if (scanStatusElement) scanStatusElement.textContent = "Loading OCR engine...";
            try {
                ocrWorker = await Tesseract.createWorker('eng', 1, {
                    logger: m => {
                        console.log(m);
                        if (m.status === 'recognizing text' && scanStatusElement) {
                             const progress = (m.progress * 100).toFixed(0);
                             scanStatusElement.textContent = `Recognizing VIN... ${progress}%`;
                        }
                    }
                });
                console.log("Tesseract worker initialized.");
                if (scanStatusElement && scanStatusElement.textContent.includes("Loading OCR")) {
                    scanStatusElement.textContent = 'Ready. Fill session info & start scanning.';
                }
            } catch(err) {
                console.error("Failed to initialize Tesseract worker:", err);
                if(scanStatusElement) {
                    scanStatusElement.textContent = "Error: Failed to load OCR engine. VIN Scan disabled.";
                    scanStatusElement.className = 'status-error';
                }
                if(modeVinButton) modeVinButton.disabled = true;
            }
        }
        
        // --- Scanning Router Functions ---
        function startScanning() {
            if (!validateSessionInfo()) return;
            if(modeQrButton) modeQrButton.disabled = true;
            if(modeVinButton) modeVinButton.disabled = true;

            if (scanMode === 'QR') startQrScanning();
            else if (scanMode === 'VIN') startVinScanning();
        }

        function stopScanning() {
            if (scanMode === 'QR') stopQrScanning();
            else if (scanMode === 'VIN') stopVinScanning();
            
            if(modeQrButton) modeQrButton.disabled = false;
            if(modeVinButton) modeVinButton.disabled = false;
        }

        function validateSessionInfo() {
            if (!locationSelect.value) {
                alert("Please select a Location before starting.");
                locationSelect.focus();
                return false;
            }
            if (!scannedByInput.value.trim()) {
                alert("Please enter your name in 'Scanned By' field.");
                scannedByInput.focus();
                return false;
            }
            return true;
        }

        // --- QR Scanning Logic ---
        function startQrScanning() {
            startButton.disabled = true;
            stopButton.disabled = false;
            locationSelect.disabled = true;
            scannedByInput.disabled = true;
            scanStatusElement.textContent = 'Initializing QR scanner...';
            scanStatusElement.className = 'status-info';
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            try {
                if (!html5QrCode) html5QrCode = new Html5Qrcode("qr-reader");
                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                    .then(() => {
                        scanStatusElement.textContent = 'Scanner started. Point at QR code.';
                        if (scannerViewportContainer) scannerViewportContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    })
                    .catch(err => {
                        scanStatusElement.textContent = `Error starting QR scanner: ${err.message}.`;
                        scanStatusElement.className = 'status-error';
                        stopQrScanning(true);
                    });
            } catch (e) {
                scanStatusElement.textContent = `QR Scanner library error: ${e.message}.`;
                scanStatusElement.className = 'status-error';
                stopQrScanning(true);
            }
        }

        function stopQrScanning(isError = false) {
            if (html5QrCode && html5QrCode.isScanning) {
                html5QrCode.stop().catch(err => console.warn("Error stopping QR scanner:", err));
            }
            qrReaderDivForLibrary.innerHTML = ""; 
            if (scanStatusElement && !isError) {
                scanStatusElement.textContent = 'Scanner stopped.';
                scanStatusElement.className = 'status-info';
            }
            startButton.disabled = false;
            stopButton.disabled = true;
            locationSelect.disabled = false; 
            scannedByInput.disabled = false; 
        }

        // --- VIN Scanning (OCR) Logic ---
        async function startVinScanning() {
            if (!ocrWorker) {
                alert("OCR Engine is not ready. Please wait or reload.");
                return;
            }
            if (isOcrRunning) return;

            startButton.disabled = true;
            stopButton.disabled = false;
            locationSelect.disabled = true;
            scannedByInput.disabled = true;
            scanStatusElement.textContent = 'Starting camera for VIN scan...';
            scanStatusElement.className = 'status-info';
            
            qrReaderDivForLibrary.innerHTML = '';
            videoElementForOcr = document.createElement('video');
            videoElementForOcr.style.width = '100%';
            videoElementForOcr.setAttribute('playsinline', '');
            qrReaderDivForLibrary.appendChild(videoElementForOcr);

            try {
                ocrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                videoElementForOcr.srcObject = ocrStream;
                await videoElementForOcr.play();
                isOcrRunning = true;
                if(vinScanOverlay) vinScanOverlay.style.display = 'block';

                scanStatusElement.textContent = 'Position VIN in the rectangle.';
                if (scannerViewportContainer) scannerViewportContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                recognizeVinLoop();
            } catch (err) {
                console.error("Error starting VIN camera:", err);
                scanStatusElement.textContent = `Camera Error: ${err.message}`;
                scanStatusElement.className = 'status-error';
                stopVinScanning();
            }
        }

        async function recognizeVinLoop() {
            if (!isOcrRunning || !videoElementForOcr) return;

            try {
                const canvas = document.createElement('canvas');
                canvas.width = videoElementForOcr.videoWidth;
                canvas.height = videoElementForOcr.videoHeight;
                canvas.getContext('2d').drawImage(videoElementForOcr, 0, 0, canvas.width, canvas.height);

                const { data } = await ocrWorker.recognize(canvas);
                const vinRegex = /[A-HJ-NPR-Z0-9]{17}/g;
                const potentialVins = data.text.toUpperCase().replace(/\s/g, '').match(vinRegex);

                if (potentialVins && potentialVins.length > 0) {
                    stopVinScanning();
                    await processSuccessfulScan(potentialVins[0], 'VIN_OCR');
                } else {
                   if (isOcrRunning) requestAnimationFrame(recognizeVinLoop);
                }
            } catch (e) {
                console.error("Error in recognition loop:", e);
                if (isOcrRunning) requestAnimationFrame(recognizeVinLoop);
            }
        }

        function stopVinScanning() {
            isOcrRunning = false;
            if (ocrStream) {
                ocrStream.getTracks().forEach(track => track.stop());
                ocrStream = null;
            }
            if (qrReaderDivForLibrary) qrReaderDivForLibrary.innerHTML = '';
            if (vinScanOverlay) vinScanOverlay.style.display = 'none';

            scanStatusElement.textContent = 'Scanner stopped.';
            scanStatusElement.className = 'status-info';
            startButton.disabled = false;
            stopButton.disabled = true;
            locationSelect.disabled = false;
            scannedByInput.disabled = false;
        }
        
        // --- Core Logic for Handling Scan Results & Data ---
        async function processSuccessfulScan(text, type) {
            const trimmedText = text.trim().toUpperCase();
            const duplicateCheckText = (type === "VIN_OCR") ? `VIN_OCR: ${trimmedText}` : trimmedText;

            if (scannedItems.some(item => item.text === duplicateCheckText)) {
                scanStatusElement.textContent = `"${trimmedText.substring(0,20)}..." already scanned.`;
                scanStatusElement.className = 'status-info';
                if (type === "VIN_OCR") setTimeout(() => startVinScanning(), 2000); // Restart after a bit
                return;
            }

            scanSuccessOverlay.classList.add('visible');
            scanStatusElement.textContent = `Found: "${trimmedText.substring(0,30)}...". Getting location...`;
            scanStatusElement.className = 'status-info';

            let geoData = { latitude: null, longitude: null, accuracy: null, geoError: null, timestamp: new Date().toISOString() };
            try {
                const location = await fetchCurrentLocation();
                geoData = {...geoData, ...location};
                scanStatusElement.textContent = `Found: "${trimmedText.substring(0,30)}...". Location captured!`;
                scanStatusElement.className = 'status-success';
            } catch (error) {
                geoData.geoError = error.message;
                scanStatusElement.textContent = `Found: "${trimmedText.substring(0,30)}...". Geo Error: ${error.message}`;
                scanStatusElement.className = 'status-error';
            }
            
            scannedItems.push({ 
                text: duplicateCheckText, 
                originalScan: trimmedText, 
                salesforceId: null, 
                manualDetails: null, 
                scanType: type,
                ...geoData 
            }); 
            updateScannedList();
            if (navigator.vibrate) navigator.vibrate(100);
            setTimeout(() => scanSuccessOverlay.classList.remove('visible'), 1200);
            
            if(type === "VIN_OCR") {
                 setTimeout(() => {
                    scanStatusElement.textContent = 'Scanner stopped. Click Start to scan again.';
                    scanStatusElement.className = 'status-info';
                 }, 2000);
            }
        }
        
        async function onScanSuccess(decodedText, decodedResult) {
            await processSuccessfulScan(decodedText, 'QR');
        }

        function onScanFailure(error) { /* console.warn(`QR error = ${error}`); */ }

        function updateScannedList() {
            scannedItemsListElement.innerHTML = '';
            scannedItems.forEach(item => {
                const listItem = document.createElement('li');
                let displayText = item.text;
                if (item.scanType === "VIN_OCR") { displayText += ` <strong style="color: #fd7e14;">(VIN Scan)</strong>`; }
                else if (item.scanType === "MANUAL") { displayText += ` <strong style="color: #28a745;">(SF Linked)</strong>`; } 
                else if (item.scanType === "MANUAL_NEW") { displayText += ` <em style="color: #17a2b8;">(New Manual)</em>`; }
                
                let geoInfo = '';
                if (item.geoError) { geoInfo = `<span class="item-geo">(Geo: ${item.geoError})</span>`; } 
                else if (item.latitude !== null) { geoInfo = `<span class="item-geo">(Lat: ${item.latitude.toFixed(5)}, Lon: ${item.longitude.toFixed(5)})</span>`; }
                listItem.innerHTML = `${displayText} ${geoInfo}`;
                scannedItemsListElement.appendChild(listItem);
            });
            sendButton.disabled = scannedItems.length === 0 || !sfConnection;
        }

        // --- Salesforce & Data Submission ---
        async function sendToSalesforce() {
            if (!sfConnection || !sfConnection.accessToken) { alert("Please login to Salesforce first."); return; }
            if (!validateSessionInfo()) return;
            if (scannedItems.length === 0) { alert("No items to send."); return; }

            scanStatusElement.textContent = 'Preparing data for Salesforce...';
            scanStatusElement.className = 'status-info';
            sendButton.disabled = true;

            const platformEventsToSend = [];
            for (const item of scannedItems) {
                let manualMake = null, manualVin = null, qrCodeText = null;

                if (item.scanType === "MANUAL" || item.scanType === "MANUAL_NEW") {
                    const parts = item.text.replace("MANUAL:", "").trim().split("- VIN:");
                    manualMake = parts[0]?.trim();
                    manualVin = parts[1]?.trim();
                    qrCodeText = item.text;
                } else if (item.scanType === "VIN_OCR") {
                    manualVin = item.originalScan;
                } else { // QR
                    qrCodeText = item.originalScan;
                }
                
                const eventPayload = {
                    Location__c: locationSelect.value,
                    Scanned_By_User__c: scannedByInput.value.trim(), 
                    Date_Scanned__c: new Date(dateScannedInput.value).toISOString(),
                    QR_Code_Text__c: qrCodeText,
                    Latitude__c: item.latitude,
                    Longitude__c: item.longitude,
                    Accuracy__c: item.accuracy,
                    Geolocation_Timestamp__c: item.timestamp ? new Date(item.timestamp).toISOString() : null,
                    Scan_Type__c: item.scanType,
                    Manual_VIN__c: manualVin,
                    Manual_Make__c: manualMake,
                    Linked_Trailer_ID__c: item.salesforceId
                };
                
                if (item.manualDetails) { 
                    eventPayload.Manual_Type__c = item.manualDetails.type; 
                    eventPayload.Manual_Trailer_Type_Spec__c = item.manualDetails.trailerType; 
                    if (item.manualDetails.model) eventPayload.Manual_Model__c = item.manualDetails.model;
                    if (item.manualDetails.owner) eventPayload.Manual_Trailer_Owner__c = item.manualDetails.owner;
                }
                
                Object.keys(eventPayload).forEach(key => (eventPayload[key] === null || eventPayload[key] === undefined) && delete eventPayload[key]);
                platformEventsToSend.push(eventPayload);
            }

            console.log("Payload to send:", JSON.stringify(platformEventsToSend, null, 2));

            try {
                const results = await sfConnection.sobject(PLATFORM_EVENT_API_NAME).create(platformEventsToSend);
                let successCount = (Array.isArray(results) ? results : [results]).filter(r => r.success).length;
                if (successCount === platformEventsToSend.length) {
                    scanStatusElement.textContent = `Successfully sent ${successCount} items to Salesforce!`;
                    scanStatusElement.className = 'status-success';
                    scannedItems.length = 0; 
                    updateScannedList(); 
                } else {
                    scanStatusElement.textContent = `Sent ${successCount}/${platformEventsToSend.length}. Check console for errors.`;
                    scanStatusElement.className = 'status-error';
                    console.error("Salesforce publish errors:", results);
                }
            } catch (err) {
                scanStatusElement.textContent = `Error sending to SF: ${err.message}`;
                scanStatusElement.className = 'status-error';
                console.error("Error publishing Platform Events:", err);
            } finally {
                sendButton.disabled = scannedItems.length === 0 || !sfConnection;
            }
        }
        
        // --- Other Utility and UI Functions (largely unchanged) ---
        // (This includes Salesforce auth, geolocation permissions, manual entry forms, VIN search)
        function checkAndShowAppContent() {
            if (isSalesforceLoggedIn && isLocationEnabled) {
                document.getElementById('main-app-content').style.display = 'block';
                document.getElementById('initial-setup-instructions').style.display = 'none';
            } else {
                document.getElementById('main-app-content').style.display = 'none';
                document.getElementById('initial-setup-instructions').style.display = 'block';
            }
        }
        function updateSalesforceLoginStatus(isLoggedIn, message) {
            isSalesforceLoggedIn = isLoggedIn;
            checkAndShowAppContent();
            if (isLoggedIn) {
                salesforceLoginButton.textContent = 'Logout from Salesforce';
                salesforceLoginButton.onclick = salesforceLogout;
                salesforceStatusElement.textContent = 'Logged in Successfully.';
                salesforceStatusElement.className = 'sf-status-message status-success';
                sendButton.disabled = scannedItems.length === 0;
            } else {
                salesforceLoginButton.textContent = 'Login to Salesforce';
                salesforceLoginButton.onclick = salesforceLogin;
                salesforceStatusElement.textContent = message || 'Not logged into Salesforce.';
                salesforceStatusElement.className = 'sf-status-message status-info';
                sendButton.disabled = true;
            }
        }
        function salesforceLogin() {
            jsforce.browser.init({ clientId: SF_CLIENT_ID, redirectUri: SF_REDIRECT_URI, loginUrl: SF_LOGIN_URL, version: '58.0' });
            jsforce.browser.login({}, (err, userInfo) => {
                if (err) { console.error("SF login error:", err); updateSalesforceLoginStatus(false, `Login failed: ${err.message}`); return; }
                sfConnection = jsforce.browser.connection;
                sfConnection.userInfo = userInfo;
                updateSalesforceLoginStatus(true);
            });
        }
        function checkSalesforceSession() {
            jsforce.browser.init({ clientId: SF_CLIENT_ID, redirectUri: SF_REDIRECT_URI, loginUrl: SF_LOGIN_URL, version: '58.0' });
            if (jsforce.browser.connection && jsforce.browser.connection.accessToken) {
                sfConnection = jsforce.browser.connection;
                sfConnection.identity((err, res) => {
                    if (err) { updateSalesforceLoginStatus(true, "Logged in (Connection issue)."); return; }
                    sfConnection.userInfo = res;
                    updateSalesforceLoginStatus(true);
                });
            } else { updateSalesforceLoginStatus(false); }
        }
        function salesforceLogout() { 
            if (sfConnection) { sfConnection.logout(err => { sfConnection = null; jsforce.browser.clear(); updateSalesforceLoginStatus(false); }); } else { jsforce.browser.clear(); updateSalesforceLoginStatus(false); }
        }
        async function checkInitialGeolocationPermission() {
            if (navigator.geolocation && typeof navigator.permissions?.query === 'function') {
                const ps = await navigator.permissions.query({ name: 'geolocation' });
                updateCheckLocationButtonText(ps.state);
                ps.onchange = () => updateCheckLocationButtonText(ps.state);
            }
        }
        function updateCheckLocationButtonText(state) {
            isLocationEnabled = (state === 'granted');
            checkAndShowAppContent();
            if (state === 'granted') { checkLocationButton.textContent = 'Location Enabled'; checkLocationButton.style.backgroundColor = '#28a745'; checkLocationButton.disabled = true; } 
            else if (state === 'denied') { checkLocationButton.textContent = 'Location Denied'; checkLocationButton.style.backgroundColor = '#dc3545'; }
            else { checkLocationButton.textContent = 'Enable Location'; }
        }
        function requestGeolocationPermission(isExplicitRequest = false) {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) { reject(new Error('Geolocation is not supported.')); return; }
                navigator.geolocation.getCurrentPosition(
                    (pos) => { updateCheckLocationButtonText('granted'); resolve({ latitude: pos.coords.latitude, longitude: pos.coords.longitude, accuracy: pos.coords.accuracy, timestamp: pos.timestamp }); },
                    (error) => { updateCheckLocationButtonText('denied'); reject(new Error('Could not get location.')); },
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            });
        }
        async function fetchCurrentLocation() { return requestGeolocationPermission(false); }
        function toggleManualEntryForm(show) {
            manualEntryFormContainer.style.display = show ? 'block' : 'none';
            if (show) {
                if(html5QrCode && html5QrCode.isScanning) stopQrScanning();
                if(isOcrRunning) stopVinScanning();
            }
        }
        // ...Other functions for manual entry and VIN search...

        // --- DOMContentLoaded Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            // Assign all DOM element variables
            locationSelect = document.getElementById('location');
            scannedByInput = document.getElementById('scannedBy');
            dateScannedInput = document.getElementById('dateScanned');
            scannerViewportContainer = document.querySelector('.scanner-viewport-container');
            qrReaderDivForLibrary = document.getElementById('qr-reader');
            scanStatusElement = document.getElementById('scan-status');
            scannedItemsListElement = document.getElementById('scanned-items-list');
            startButton = document.getElementById('startButton');
            stopButton = document.getElementById('stopButton');
            sendButton = document.getElementById('sendButton');
            checkLocationButton = document.getElementById('checkLocationButton');
            scanSuccessOverlay = document.getElementById('scan-success-overlay');
            toggleManualEntryButton = document.getElementById('toggleManualEntryButton');
            manualEntryFormContainer = document.getElementById('manualEntryFormContainer');
            salesforceLoginButton = document.getElementById('salesforceLoginButton');
            salesforceStatusElement = document.getElementById('salesforceStatus');
            modeQrButton = document.getElementById('modeQrButton');
            modeVinButton = document.getElementById('modeVinButton');
            vinScanOverlay = document.getElementById('vin-scan-overlay');
            // ... all other manual entry form elements would be assigned here ...
            
            // Set date
            dateScannedInput.value = new Date().toISOString().split('T')[0];

            // Initialize OCR Engine
            initializeOcrWorker();

            // Set up event listeners
            salesforceLoginButton.onclick = salesforceLogin;
            startButton.addEventListener('click', startScanning);
            stopButton.addEventListener('click', stopScanning);
            sendButton.addEventListener('click', sendToSalesforce);
            checkLocationButton.addEventListener('click', () => requestGeolocationPermission(true));
            toggleManualEntryButton.addEventListener('click', () => toggleManualEntryForm(manualEntryFormContainer.style.display !== 'block'));

            modeQrButton.addEventListener('click', () => {
                scanMode = 'QR';
                modeQrButton.classList.add('active');
                modeVinButton.classList.remove('active');
                vinScanOverlay.style.display = 'none';
            });
            modeVinButton.addEventListener('click', () => {
                scanMode = 'VIN';
                modeVinButton.classList.add('active');
                modeQrButton.classList.remove('active');
            });
            
            // Initial checks
            checkInitialGeolocationPermission();
            checkSalesforceSession();
            checkAndShowAppContent();
        });
    </script>
</body>
</html>
